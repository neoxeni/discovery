<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mercury.discovery.base.company.service.CompanyRepository">

    <select id="findAll" resultType="Company">
        SELECT *
        FROM tb_cmm_company
        WHERE cmpny_no != -1

        <if test='cmpnyNo != null'>
            AND cmpny_no = #{cmpnyNo}
        </if>
        <if test='status != null and status != ""'>
            AND status = #{status}
        </if>

    </select>

    <select id="getCompany" resultType="Company">
        SELECT *
        FROM tb_cmm_company
        WHERE cmpny_no = #{cmpnyNo}
    </select>

    <!-- {AES.enc}eOzqz+OVVioH5bhWEECuaw== : PROTECTED -->
    <update id="update">
        UPDATE tb_cmm_company
        <trim prefix="SET" suffixOverrides=",">
            <if test="cmpnyNm != null">cmpny_nm = #{cmpnyNm},</if>
            <if test="telNo != null">tel_no = #{telNo},</if>
            <if test="ceoNm != null">ceo_nm = #{ceoNm},</if>
            <if test="domain != null">domain = #{domain},</if>
            <if test="domainUseYn != null">domain_use_yn = #{domainUseYn},</if>
            <if test="addr != null">addr = #{addr},</if>
            <if test="bizNo != null">biz_no = #{bizNo},</if>

            <if test="callTelNo != null">call_tel_no = #{callTelNo},</if>
            <if test="smsTelNo != null">sms_tel_no = #{smsTelNo},</if>
            <if test="email != null">email = #{email},</if>
            <if test="emailPw != null and emailPw != '{AES.enc}eOzqz+OVVioH5bhWEECuaw=='">email_pw = #{emailPw},</if>

            <if test="smtpHost != null">smtp_host = #{smtpHost},</if>

            <choose>
                <when test="smtpPort == 0">
                    smtp_port = null,
                </when>
                <when test="smtpHost != null">
                    smtp_port = #{smtpPort},
                </when>
            </choose>

            <if test="smtpSslYn != null">smtp_ssl_yn = #{smtpSslYn},</if>

            <if test="status != null">status = #{status},</if>
            <if test="holdingsNo != null">holdings_no = #{holdingsNo},</if>
            <if test="cntnt != null">cntnt = #{cntnt},</if>
        </trim>
        WHERE cmpny_no = #{cmpnyNo}
    </update>

    <update id="updateEmailPassword">
        UPDATE tb_cmm_company SET
            email_pw = #{newPassword}
        WHERE cmpny_no = #{cmpnyNo}
    </update>

    <insert id="insert" useGeneratedKeys="true" keyProperty="cmpnyNo">
        <selectKey keyProperty="cmpnyNo" resultType="int" order="BEFORE" databaseId="oracle">
            select sq_cmm_company.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO tb_cmm_company(cmpny_no,
            cmpny_nm, cmpny_id, tel_no, ceo_nm, domain, addr, email, biz_no,
            domain_use_yn, reg_dt, status, call_tel_no, holdings_no, cntnt
        )VALUES(#{cmpnyNo},
            #{cmpnyNm}, #{cmpnyId}, #{telNo}, #{ceoNm}, #{domain}, #{addr}, #{email}, #{bizNo},
            #{domainUseYn}, #{regDt}, #{status}, #{callTelNo}, #{holdingsNo}, #{cntnt}
        )
    </insert>


    <select id="getDomain" resultType="String">
        SELECT cmpny_id
        FROM (
            SELECT cmpny_id
            FROM tb_cmm_company
            WHERE cmpny_id = #{cmpnyId}
            UNION ALL
            SELECT '1' cmpny_id
            FROM tb_cmm_glbl_config
            WHERE ky = 'LOCK_DOMAIN_NM'
            AND cmpny_no = '-1'
            AND val = #{cmpnyId}
        ) tt
    </select>

    <update id="confirm">
        UPDATE tb_cmm_company SET
            status = #{status}
        WHERE cmpny_no = #{cmpnyNo}
    </update>

    <select id="getDomainsFindByEmail" resultType="String">
        SELECT group_concat(distinct cmpny_id) cmpny_id
        FROM tb_cmm_company
        WHERE cmpny_id IS NOT null
        AND
        cmpny_no IN
        (
            SELECT cmpny_no
            FROM tb_cmm_emp
            WHERE email = #{email}
            AND rtrmnt_yn = 'N'
        )

    </select>


    <delete id="deleteCompany">
        DELETE FROM tb_ir_conversation WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board_hst WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_tenancy WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cust WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board_search WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_service_option_order WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_article WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_board_manage WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_service_product_order WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_rcv_callback WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_rcv_rsrv WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_calendar_global WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board_read_hst WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board_rcm WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_scenario_scenario WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_know_board_mngr WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_scenario_service WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_scenario_node WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_scenario_hist WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_stats_keyword WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_queue WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_refusal_word WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_system_message WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_system_message_variable WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_ir_usermap WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_service_license_request WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_service_request WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_admin_log WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_attach_file WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_calendar_person WHERE emp_no in ( SELECT emp_no FROM tb_cmm_emp WHERE cmpny_no = #{cmpnyNo});
        DELETE FROM tb_cmm_category WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_code_div WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_code WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_cstm_fld_map WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_cstm_fld_data WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_cstm_fld_grp WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_dept WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_email_trans WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_sms_trans WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_faq WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_glbl_config WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_group_map_hst WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_group_map WHERE reg_emp_no in ( SELECT emp_no FROM tb_cmm_emp WHERE cmpny_no = #{cmpnyNo});
        DELETE FROM tb_cmm_group WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_login_hist WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_logout_hist WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_tmpl_contents WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_tmpl_contents_macro WHERE emp_no in ( SELECT emp_no FROM tb_cmm_emp WHERE cmpny_no = #{cmpnyNo});
        DELETE FROM tb_cmm_login WHERE emp_no IN (SELECT emp_no FROM tb_cmm_emp WHERE cmpny_no = #{cmpnyNo});
        DELETE FROM tb_cmm_emp WHERE cmpny_no = #{cmpnyNo};
        DELETE FROM tb_cmm_company WHERE cmpny_no = #{cmpnyNo};
    </delete>

</mapper>