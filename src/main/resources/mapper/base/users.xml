<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mercury.discovery.base.users.service.UserRepository">

    <sql id="user_all">
        ${l}.username,
        ${l}.password,
        ${l}.password_err_count,
        ${l}.password_updated_at,
        ${l}.last_login_at,
        ${l}.last_logout_at,
        ${l}.last_ip_address,

        ${e}.id,
        ${e}.name,
        ${e}.nickname,
        ${e}.phone,
        ${e}.email,
        ${e}.identification,
        ${e}.position_cd,
        ${e}.duty_cd,
        ${e}.sort,
        ${e}.join_date,
        ${e}.is_retire,
        ${e}.retire_date,

        ${e}.created_by,
        ${e}.created_at,
        ${e}.updated_by,
        ${e}.updated_at,
        ${e}.user_key,

        ${e}.client_id,
        ${e}.department_id
    </sql>

    <!--로그인 전용-->
    <select id="findByUserIdForLogin" resultType="AppUser">
        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
        </include>
        FROM client_user e JOIN client_user_login l ON e.id = l.user_id
        WHERE l.username = #{userId}
    </select>

    <select id="findByUserId" resultType="AppUser">
        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
        </include>
        FROM client_user e JOIN client_user_login l ON e.id = l.user_id
        WHERE e.id = #{id}
    </select>

    <select id="findByUserKey" resultType="AppUser">
        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
            <property name="dept" value="dept"/>
            <property name="postn" value="postn"/>
            <property name="duty" value="duty"/>
        </include>
        FROM tb_cmm_emp e
            JOIN tb_cmm_login l ON e.emp_no = l.emp_no
            LEFT OUTER JOIN tb_cmm_dept dept ON e.dept_no = dept.dept_no
            LEFT OUTER JOIN tb_cmm_code postn ON e.postn_cd = postn.cd AND postn.cmpny_no = e.cmpny_no  AND postn.div_cd = 'OR02'
            LEFT OUTER JOIN tb_cmm_code duty ON e.duty_cd = duty.cd  AND duty.cmpny_no = e.cmpny_no AND duty.div_cd = 'OR01'
        WHERE e.user_key = #{userKey}
    </select>



    <select id="find" resultType="AppUser">
        SELECT  <include refid="user_all">
        <property name="e" value="e"/>
        <property name="l" value="l"/>
        <property name="dept" value="dept"/>
        <property name="postn" value="postn"/>
        <property name="duty" value="duty"/>
        </include>
        FROM tb_cmm_emp e
            JOIN tb_cmm_login l ON e.emp_no = l.emp_no
            LEFT OUTER JOIN tb_cmm_dept dept ON e.dept_no = dept.dept_no
            LEFT OUTER JOIN tb_cmm_code postn ON e.postn_cd = postn.cd AND postn.cmpny_no = e.cmpny_no  AND postn.div_cd = 'OR02'
            LEFT OUTER JOIN tb_cmm_code duty ON e.duty_cd = duty.cd AND duty.cmpny_no = e.cmpny_no AND duty.div_cd = 'OR01'
        WHERE e.cmpny_no = #{clientId}
        <choose>
            <when test="empNo != null">
                AND e.emp_no = #{empNo}
            </when>
            <when test="grpCd != null">
                AND e.emp_no IN (
                    SELECT
                        b.data_no as emp_no
                    FROM tb_cmm_group a
                        JOIN tb_cmm_group_map b on a.grp_no  = b.grp_no
                    WHERE a.cmpny_no = #{clientId}
                    AND a.grp_cd = #{grpCd}
                    AND b.data_gbn = 'E'

                    UNION ALL

                    SELECT
                        emp_no
                    FROM tb_cmm_emp
                    WHERE dept_no IN (
                        SELECT
                            b.data_no
                        FROM tb_cmm_group a
                            JOIN tb_cmm_group_map b on a.grp_no  = b.grp_no
                        WHERE a.cmpny_no = #{clientId}
                        AND a.grp_cd = #{grpCd}
                        AND b.data_gbn = 'D'
                    )
                )
            </when>
        </choose>

        <if test="empNm != null">
            AND e.emp_nm = #{empNm}
        </if>
    </select>

    <select id="findRolesByEmpNo" resultType="UserRole">
        SELECT cg.grp_no, cg.grp_cd, cg.grp_nm, cgm.map_no, cgm.data_gbn, cgm.data_no, cg.cmpny_no
        FROM tb_cmm_group_map cgm JOIN tb_cmm_group cg ON cgm.grp_no = cg.grp_no
        WHERE data_gbn = 'E'
        AND data_no = #{empNo}
    </select>

    <select id="findAppRolesByEmpNo" resultType="UserAppRole">
        SELECT ag.app_grp_no, ag.app_grp_cd, ag.app_grp_nm, agm.map_no, agm.data_gbn, agm.data_no, ag.cmpny_no
        FROM tb_cmm_app_group_map agm JOIN tb_cmm_app_group ag ON agm.app_grp_no = ag.app_grp_no
        WHERE data_gbn = 'E'
        AND data_no = #{empNo}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="empNo">
        <selectKey keyProperty="empNo" resultType="int" order="BEFORE" databaseId="oracle">
            SELECT sq_cmm_emp.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO tb_cmm_emp(emp_no,
            dept_no, emp_nm, ext_tel_no, hire_dd
            , rtrmnt_yn, rtrmnt_dd, reg_emp_no, reg_dt, phone_user_id, phone_user_tel, phone_extension_no
            ,postn_cd, duty_cd, cmpny_no, emp_sort, email, emp_tp, real_emp_nm, user_key
        ) VALUES ( #{empNo},
            #{deptNo}, #{empNm}, #{extTelNo}, #{hireDd},
            #{rtrmntYn}, #{rtrmntDd}, #{regEmpNo}, #{regDt}, #{phoneUserId}, #{phoneUserTel}, #{phoneExtensionNo}
            , #{postnCd}, #{dutyCd}, #{clientId}, #{empSort}, #{email}, #{empTp}, #{realEmpNm}, #{userKey}
        )
    </insert>

    <insert id="insertLogin">
        INSERT INTO tb_cmm_login
        ( user_id, psswd, psswd_err_num, emp_no )
        VALUES
        ( #{id},#{psswd},0 ,#{empNo})
    </insert>

    <insert id="insertLoginHistory">
        INSERT INTO client_user_login_hist (
            user_id, login_at, last_ip_address, client_id
        )VALUES(
            #{id}, #{lastLoginAt} ,#{lastIpAddress}, #{clientId}
        )
    </insert>

    <update id="update">
        UPDATE tb_cmm_emp SET
        cmpny_emp_cd = #{cmpnyEmpCd}
        , dept_no = #{deptNo}
        , emp_nm = #{empNm}
        , ext_tel_no = #{extTelNo}
        , hire_dd = #{hireDd}
        , rtrmnt_yn = #{rtrmntYn}
        , rtrmnt_dd = #{rtrmntDd}
        , upd_emp_no = #{updEmpNo}
        , upd_dt  = #{updDt}
        , phone_user_id = #{phoneUserId}
        , phone_user_tel = #{phoneUserTel}
        , phone_extension_no = #{phoneExtensionNo}
        , postn_cd = #{postnCd}
        , duty_cd = #{dutyCd}
        , emp_sort = #{empSort}
        , email = #{email}
        , emp_tp = #{empTp}
        , real_emp_nm = #{realEmpNm}
        WHERE emp_no = #{empNo}
        AND cmpny_no= #{clientId}
    </update>

    <update id="updateLoginInfo">
        UPDATE client_user_login SET
            password_err_count = 0,
            password_updated_at = #{lastLoginAt},
            last_ip_address = #{lastIpAddress}
        WHERE user_id = #{id}
    </update>

    <update id="updateLoginId">
        UPDATE client_user_login SET
            username = #{username}
        WHERE user_id = #{id}
    </update>

    <update id="updateLogoutInfo">
        UPDATE client_user_login SET
            last_logout_at = #{lastLogoutAt}
        WHERE user_id = #{id}
    </update>

    <update id="plusPasswordErrorCount">
        <selectKey keyProperty="psswdErrNum" resultType="int" order="AFTER">
            SELECT psswd_err_num FROM tb_cmm_login WHERE emp_no = #{empNo}
        </selectKey>

        UPDATE tb_cmm_login SET
            psswd_err_num = psswd_err_num + 1
        WHERE emp_no = #{empNo}
    </update>

    <update id="resetPassword">
        UPDATE tb_cmm_login SET
            psswd = #{psswd},
            psswd_err_num = 0,
            psswd_upd_dt = #{psswdUpdDt}
        WHERE emp_no = #{empNo}
    </update>

    <delete id="delete">
        DELETE FROM tb_cmm_emp
        WHERE emp_no = #{empNo}
        AND cmpny_no = #{clientId}
    </delete>

    <update id="resetPasswordCount">
        UPDATE client_user_login SET
            password_err_count = 0
        WHERE user_id = #{id}
    </update>

    <!--로그인 전용-->
    <select id="findByUserEmail" resultType="AppUser">
        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
            <property name="dept" value="dept"/>
            <property name="postn" value="postn"/>
            <property name="duty" value="duty"/>
        </include>
        ,psswd
        FROM tb_cmm_emp e
        JOIN tb_cmm_login l ON e.emp_no = l.emp_no
        LEFT OUTER JOIN tb_cmm_dept dept ON e.dept_no = dept.dept_no
        LEFT OUTER JOIN tb_cmm_code postn ON e.postn_cd = postn.cd AND postn.cmpny_no = e.cmpny_no AND postn.div_cd = 'OR02'
        LEFT OUTER JOIN tb_cmm_code duty ON e.duty_cd = duty.cd AND duty.cmpny_no = e.cmpny_no AND duty.div_cd = 'OR01'
        WHERE e.email = #{email}
        LIMIT 1
    </select>


    <!--로그인 전용-->
    <select id="findByUserEmailWithCmpnyId" resultType="AppUser">

        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
            <property name="dept" value="dept"/>
            <property name="postn" value="postn"/>
            <property name="duty" value="duty"/>
        </include>
        ,psswd
        FROM tb_cmm_emp e
        JOIN tb_cmm_login l ON e.emp_no = l.emp_no
        JOIN tb_cmm_company c ON e.cmpny_no = c.cmpny_no
        LEFT OUTER JOIN tb_cmm_dept dept ON e.dept_no = dept.dept_no
        LEFT OUTER JOIN tb_cmm_code postn ON e.postn_cd = postn.cd AND postn.cmpny_no = e.cmpny_no AND postn.div_cd = 'OR02'
        LEFT OUTER JOIN tb_cmm_code duty ON e.duty_cd = duty.cd  AND duty.cmpny_no = e.cmpny_no AND duty.div_cd = 'OR01'
        WHERE e.email = #{email}
        AND c.cmpny_id = #{cmpnyId}
    </select>

    <select id="getEmail" resultType="String">
        SELECT a.email
        FROM tb_cmm_emp a,
            tb_cmm_company b
        WHERE a.cmpny_no = b.cmpny_no
        AND rtrmnt_yn = 'N'
        AND a.email = #{email}
        AND b.cmpny_id = #{cmpnyId}
    </select>

    <select id="getEmailForDomain" resultType="String">
        SELECT a.email
        FROM tb_cmm_emp a
        WHERE 1=1
        AND rtrmnt_yn = 'N'
        AND a.email = #{email}
        LIMIT 1
    </select>

    <select id="getUserId" resultType="String">
        SELECT user_id
        FROM tb_cmm_login a,
            tb_cmm_emp b,
            tb_cmm_company c
        WHERE a.emp_no = b.emp_no
        AND b.cmpny_no = c.cmpny_no
        AND b.rtrmnt_yn = 'N'
        AND a.user_id = #{userId}
        AND c.cmpny_id = #{cmpnyId}
    </select>

    <select id="findDeptEmpList" resultType="AppUser">
        SELECT
        <include refid="user_all">
            <property name="e" value="e"/>
            <property name="l" value="l"/>
            <property name="dept" value="dept"/>
            <property name="postn" value="postn"/>
            <property name="duty" value="duty"/>
        </include>
        FROM tb_cmm_emp e
        JOIN tb_cmm_login l ON e.emp_no = l.emp_no
        LEFT OUTER JOIN tb_cmm_dept dept ON e.dept_no = dept.dept_no
        LEFT OUTER JOIN tb_cmm_code postn ON e.postn_cd = postn.cd AND postn.cmpny_no = e.cmpny_no  AND postn.div_cd = 'OR02'
        LEFT OUTER JOIN tb_cmm_code duty ON e.duty_cd = duty.cd  AND duty.cmpny_no = e.cmpny_no AND duty.div_cd = 'OR01'
        WHERE e.dept_no = #{deptCd}
        AND e.cmpny_no = #{clientId}
        AND e.rtrmnt_yn = #{rtrmntYn}
        ORDER BY e.emp_nm

    </select>
</mapper>
